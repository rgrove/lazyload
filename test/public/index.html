<!DOCTYPE html>
<html>
  <head>
    <title>LazyLoad Test</title>
    <style>
      fieldset {
        border: 1px solid #afafaf;
        margin-bottom: 1em;
      }

      .log {
        font: 10pt Consolas, Menlo, Monaco, fixed;
        width: 100%;
      }

      #css-status {
        background-color: #fff;
        height: 30px;
        margin: 10px auto;
        width: 100px;
      }

      #n1,#n2,#n3,#n4,#n5,#n6,#n7,#n8,#n9,#n10 { width: 0; }
    </style>
  </head>
  <body>
    <h1>LazyLoad Test</h1>

    <form>
      <fieldset>
        <legend>JavaScript</legend>

        <p>
          <input type="button" id="btnLoadJS" value="Load JS (sequential calls)">
          <input type="button" id="btnLoadJSSingle" value="Load JS (single call)">
          <label><input type="checkbox" id="jsDelay" checked> Random delay</label>
          <label><input type="checkbox" id="jsOnce"> Load once</label>
        </p>

        <p>
          <textarea id="jslog" class="log" rows="15" cols="50"></textarea>
        </p>
      </fieldset>

      <fieldset>
        <legend>CSS</legend>

        <p>
          <input type="button" id="btnLoadCSS" value="Load CSS (sequential calls)">
          <input type="button" id="btnLoadCSSSingle" value="Load CSS (single call)">
          <label><input type="checkbox" id="cssDelay" checked> Random delay</label>
          <label><input type="checkbox" id="cssOnce"> Load once</label>
        </p>

        <p>
          <textarea id="csslog" class="log" rows="15" cols="50"></textarea>
        </p>

        <div id="css-status"></div>

        <div id="n1"></div>
        <div id="n2"></div>
        <div id="n3"></div>
        <div id="n4"></div>
        <div id="n5"></div>
      </fieldset>

      <fieldset>
        <legend>JavaScript and CSS</legend>

        <p>
          <input type="button" id="btnLoadBoth" value="Load JS+CSS (sequential calls)">
          <input type="button" id="btnLoadBothSingle" value="Load JS+CSS (single call)">
          <label><input type="checkbox" id="bothOnce"> Load once</label>
        </p>

      </fieldset>

    </form>

    <script src="lazyload.js"></script>
    <script>
      var btnLoadCSS       = document.getElementById('btnLoadCSS'),
          btnLoadCSSSingle = document.getElementById('btnLoadCSSSingle'),
          btnLoadJS        = document.getElementById('btnLoadJS'),
          btnLoadJSSingle  = document.getElementById('btnLoadJSSingle'),
          btnLoadJS        = document.getElementById('btnLoadJS'),
          btnLoadJSSingle  = document.getElementById('btnLoadJSSingle'),
          btnLoadBoth        = document.getElementById('btnLoadBoth'),
          btnLoadBothSingle  = document.getElementById('btnLoadBothSingle'),
          cssDelay         = document.getElementById('cssDelay'),
          cssLogEl         = document.getElementById('csslog'),
          jsDelay          = document.getElementById('jsDelay'),
          jsLogEl          = document.getElementById('jslog'),
		  cssOnce		   = document.getElementById('cssOnce'),
		  jsOnce		   = document.getElementById('jsOnce'),
		  bothOnce		   = document.getElementById('bothOnce'),

          n1 = document.getElementById('n1'),
          n2 = document.getElementById('n2'),
          n3 = document.getElementById('n3'),
          n4 = document.getElementById('n4'),
          n5 = document.getElementById('n5'),

          cssInterval = null,

          js = [
            'http://pieisgood.org/test/lazyload/js.php?num=1',
            'http://pieisgood.org/test/lazyload/js.php?num=2',
            'http://pieisgood.org/test/lazyload/js.php?num=3',
            'http://pieisgood.org/test/lazyload/js.php?num=4',
            'http://pieisgood.org/test/lazyload/js.php?num=5'
          ];

      function cssComplete() {
        csslog('callback');
      }

      function csslog(message) {
        cssLogEl.value += "[" + (new Date()).toTimeString() + "] " + message + "\r\n";
      }

      function cssPollStart() {
        var check = [n1, n2, n3, n4, n5],
            i, item;

        cssPollStop();

        var links = document.getElementsByTagName('link');

        cssInterval = setInterval(function () {
          for (i = 0; i < check.length; ++i) {
            item = check[i];

            if (item.offsetWidth > 0) {
              check.splice(i, 1);
              i -= 1;

              csslog('stylesheet ' + item.id.substr(1) + ' applied');
            }
          }

          if (!check.length) {
            cssPollStop();
          }
        }, 30);
      }

      function cssPollStop() {
        clearInterval(cssInterval);
      }

      // Returns a delay between 0 and 5000ms if enabled.
      function getCSSDelay() {
          return cssDelay.checked ? Math.floor(Math.random() * 5001) : 0;
      }

      function getCSSUrls() {
          return [
            '/css?num=1&delay=' + getCSSDelay(),
            '/css?num=2&delay=' + getCSSDelay(),
            '/css?num=3&delay=' + getCSSDelay(),
            '/css?num=4&delay=' + getCSSDelay(),
            '/css?num=5&delay=' + getCSSDelay()
          ];
      }

      // Returns a delay between 0 and 5000ms if enabled.
      function getJSDelay() {
          return jsDelay.checked ? Math.floor(Math.random() * 5001) : 0;
      }

      // Returns a delay between 0 and 5000ms if enabled.
      function getBothDelay() {
          return bothDelay.checked ? Math.floor(Math.random() * 5001) : 0;
      }

	  // Returns parameter to only load files once
	  function getJSOnce() {
		  return jsOnce.checked;
	  }

	  // Returns parameter to only load files once
	  function getCSSOnce() {
		  return cssOnce.checked;
	  }

	  // Returns parameter to only load files once
	  function getBothOnce() {
		  return bothOnce.checked;
	  }

      function getJSUrls() {
          return [
            '/js?num=1&delay=' + getJSDelay(),
            '/js?num=2&delay=' + getJSDelay(),
            '/js?num=3&delay=' + getJSDelay(),
            '/js?num=4&delay=' + getJSDelay(),
            '/js?num=5&delay=' + getJSDelay()
          ];
      }

      function jsComplete() {
        jslog('callback');
      }

      function bothComplete() {
		console.log("both complete");
	    jsComplete();
	    cssComplete();
      }

      function jslog(message) {
        jsLogEl.value += "[" + (new Date()).toTimeString() + "] " + message + "\r\n";
      }

      btnLoadCSS.onclick = function () {
        var urls = getCSSUrls();
		var once = !!getCSSOnce();

        cssPollStart();
        csslog('loading (sequential calls)');

        for (var i = 0; i < urls.length; ++i) {
          LazyLoad.css(urls[i], cssComplete, null, null, once);
        }
      }

      btnLoadCSSSingle.onclick = function () {
        cssPollStart();
        csslog('loading (single call)');

		var once = !!getCSSOnce();

        LazyLoad.css(getCSSUrls(), cssComplete, null, null, once);
      }

      btnLoadJS.onclick = function () {
        var urls = getJSUrls();
		var once = !!getJSOnce();

        jslog('loading (sequential calls)');

        for (var i = 0; i < urls.length; ++i) {
          LazyLoad.js(urls[i], jsComplete, null, null, once);
        }
      }

      btnLoadJSSingle.onclick = function () {
		var once = !!getJSOnce();

        jslog('loading (single call)');

        LazyLoad.js(getJSUrls(), jsComplete, null, null, once);
      }

      btnLoadBoth.onclick = function () {
		var once = !!getBothOnce();
        var urls = getJSUrls().concat(getCSSUrls());
        cssPollStart();

        jslog('JS: loading (sequential calls)');
        csslog('CSS: loading (sequential calls)');

        for (var i = 0; i < urls.length; ++i) {
		  var type = urls[i].match("js|css")[0];
          LazyLoad.loadOnce(urls[i], window[type + "Complete"]);
        }
      }

      btnLoadBothSingle.onclick = function () {
		var once = !!getBothOnce();
        cssPollStart();

        jslog('JS: loading (single call)');
        csslog('CSS: loading (single call)');

        LazyLoad.loadOnce(getJSUrls().concat(getCSSUrls()), bothComplete);
      }

	  jsOnce.onclick = function () {
		jsDelay.checked = false;
	  };

	  cssOnce.onclick = function () {
		cssDelay.checked = false;
	  };

    </script>
  </body>
</html>
